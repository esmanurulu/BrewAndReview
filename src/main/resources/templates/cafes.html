<!DOCTYPE html>
<html lang="tr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Kafeler - Brew&Review</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* --- GENEL AYARLAR --- */
        body { background-color: #3e2723; color: #fcf6f0; font-family: 'Poppins', sans-serif; padding: 0; margin: 0; overflow-x: hidden; }
        .main-container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; padding-bottom: 100px; }
        
        /* Sol √úst √áekirdek */
        .profile-icon-container { position: fixed; top: 20px; left: 20px; z-index: 1000; transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .profile-icon-container img { width: 60px; height: 60px; filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.5)); }
        .profile-icon-container:hover { transform: scale(1.2) rotate(720deg); cursor: pointer; }
        
        .header-area { text-align: center; margin-bottom: 40px; }
        .header-area h1 { font-size: 3rem; color: #ffca28; margin: 15px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .btn-nav { background: rgba(255, 255, 255, 0.1); color: #d7ccc8; padding: 8px 20px; border-radius: 30px; text-decoration: none; font-size: 0.9rem; border: 1px solid #8d6e63; transition: 0.3s; display: inline-block; }
        .btn-nav:hover { background: #ffca28; color: #3e2723; border-color: #ffca28; }
        
        /* KONTROL PANELI */
        .controls-wrapper {
            background: rgba(255,255,255,0.05); padding: 20px; border-radius: 20px; border: 1px solid #5d4037;
            margin-bottom: 30px; display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; align-items: center;
        }
        .search-group { display: flex; gap: 10px; align-items: center; }
        input { padding: 10px; border-radius: 8px; border: none; width: 200px; font-family: inherit; font-size: 1rem; }
        button { padding: 10px 20px; border-radius: 8px; border: none; background: #d7ccc8; color: #3e2723; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 1rem; }
        button:hover { background: #ffca28; transform: translateY(-2px); }
        
        .sort-links { display: flex; align-items: center; gap: 10px; color: #d7ccc8; }
        .sort-links a { color: #ffca28; text-decoration: none; font-weight: bold; border-bottom: 1px dashed transparent; transition: 0.3s; }
        .sort-links a:hover { border-bottom: 1px dashed #ffca28; }

        /* G√ñR√úN√úM DEƒûƒ∞≈ûTƒ∞RME BUTONLARI */
        .view-toggle { display: flex; gap: 0; background: rgba(0,0,0,0.3); border-radius: 10px; overflow: hidden; margin-bottom: 20px; justify-content: center; width: fit-content; margin: 0 auto 30px auto; }
        .toggle-btn { padding: 10px 25px; cursor: pointer; border: none; background: transparent; color: #aaa; font-weight: bold; font-size: 1rem; transition: 0.3s; }
        .toggle-btn.active { background: #ffca28; color: #3e2723; }
        .toggle-btn:hover:not(.active) { color: #fff; }

        /* Lƒ∞STE G√ñR√úN√úM√ú */
        .cafe-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 40px; row-gap: 50px; }
        .cafe-card { background: #5d4037; border: 2px solid #8d6e63; border-radius: 25px; padding: 30px; transition: transform 0.3s, box-shadow 0.3s; display: flex; flex-direction: column; justify-content: space-between; min-height: 350px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .cafe-card:hover { transform: translateY(-10px); background: #6d4c41; box-shadow: 0 20px 40px rgba(0,0,0,0.4); border-color: #ffca28; }
        .cafe-card h2 { margin-top: 0; color: #fff; font-size: 1.5rem; }
        .rating { color: #ffca28; font-weight: bold; font-size: 1.2rem; margin: 15px 0; display: flex; align-items: center; gap: 8px; }
        .badge { background: #8d6e63; padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; display: inline-block; margin-top: 5px; color: #efebe9; }
        .address { font-size: 0.95rem; opacity: 0.7; margin-top: 15px; line-height: 1.5; color: #d7ccc8; }
        .btn-detail { width: 100%; padding: 15px; background: #ffca28; color: #3e2723; border: none; border-radius: 15px; font-weight: bold; cursor: pointer; margin-top: 25px; transition: 0.3s; font-size: 1.1rem; }
        .btn-detail:hover { background: #ffb300; letter-spacing: 1px; }

        /* HARƒ∞TA ALANI */
        #map { height: 600px; width: 100%; border-radius: 20px; border: 2px solid #ffca28; display: none; z-index: 1;}
    </style>
</head>
<body>

    <a href="/profile" class="profile-icon-container" title="Profilime Git">
        <img th:src="@{/images/bean.png}" alt="Profil">
    </a>

    <div class="main-container">

        <div class="header-area">
            <a href="/dashboard" class="btn-nav">‚Üê Ana Ekrana D√∂n</a>
            <h1>Kafeleri Ke≈üfet ‚òïÔ∏è</h1>
        </div>

        <div class="controls-wrapper">
            <form action="/cafes" method="get" class="search-group">
                <input type="text" name="city" list="citySuggestions" placeholder="≈ûehir Ara (√∂rn: Istanbul)">
                <datalist id="citySuggestions">
                    <option th:each="city : ${cityList}" th:value="${city}"></option>
                </datalist>
                <button type="submit">üìç Ara</button>
            </form>

            <form action="/cafes" method="get" class="search-group">
                <input type="text" name="name" placeholder="Kafe Adƒ± Ara...">
                <button type="submit">üîç Ara</button>
            </form>

            <form action="/cafes" method="get" style="margin:0;">
                <input type="hidden" name="dessert" value="true">
                <button type="submit" style="background:#8d6e63; color:white;">üç∞ Tatlƒ±sƒ± Olanlar</button>
            </form>
            
            <a href="/cafes"><button style="background:transparent; border:1px solid #d7ccc8; color:#d7ccc8;">Sƒ±fƒ±rla</button></a>

            <div class="sort-links">
                <span style="opacity:0.7;">Sƒ±rala:</span>
                <a href="/cafes?sort=az">A-Z</a>
                <span style="opacity:0.3;">|</span>
                <a href="/cafes?sort=rating">Puan (En Y√ºksek)</a>
            </div>
        </div>

        <div class="view-toggle">
            <button id="btn-list-view" class="toggle-btn active" onclick="showList()">üìã Liste G√∂r√ºn√ºm√º</button>
            <button id="btn-map-view" class="toggle-btn" onclick="showMap()">üó∫Ô∏è Harita G√∂r√ºn√ºm√º</button>
        </div>

        <div id="cafe-list-container" class="cafe-grid">
            <div class="cafe-card" th:each="cafe : ${cafes}">
                <div>
                    <h2 th:text="${cafe.name}">Kafe Adƒ±</h2>
                    <div style="display: flex; align-items: center; gap: 5px; color: #d7ccc8;">
                        <span>üìç</span> <span th:text="${cafe.city}">≈ûehir</span>
                    </div>
                    
                    <div class="rating">
                        <span th:if="${cafe.totalRating != null}" style="display: flex; align-items: center; gap: 5px;">
                            <img th:src="@{/images/bean.png}" width="24" style="filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.5));"> 
                            <span th:text="${cafe.totalRating}">4.5</span> / 5.0
                        </span>
                        <span th:if="${cafe.totalRating == null}" style="color: #a1887f; font-size: 0.9rem; font-style: italic;">
                            üÜï Hen√ºz Puanlanmadƒ±
                        </span>
                    </div>

                    <span th:if="${cafe.hasDessert}" class="badge">üç∞ Tatlƒ± Mevcut</span>
                    <p class="address" th:text="${cafe.address}">Adres</p>
                </div>
                <a th:href="@{/cafe/{id}(id=${cafe.cafeId})}" style="text-decoration: none;">
                    <button class="btn-detail">ƒ∞ncele</button>
                </a>
            </div>
        </div>

        <div id="map"></div>

    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
            var cafes = /*[[${cafes}]]*/ [];
        /*]]>*/

        var map = null;

        function showList() {
            document.getElementById('cafe-list-container').style.display = 'grid';
            document.getElementById('map').style.display = 'none';
            document.getElementById('btn-list-view').classList.add('active');
            document.getElementById('btn-map-view').classList.remove('active');
        }

        function showMap() {
            document.getElementById('cafe-list-container').style.display = 'none';
            document.getElementById('map').style.display = 'block';
            document.getElementById('btn-list-view').classList.remove('active');
            document.getElementById('btn-map-view').classList.add('active');

            if (map === null) {
                initMap();
            } else {
                map.invalidateSize(); 
            }
        }

        function initMap() {
            map = L.map('map').setView([39.0, 35.0], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            cafes.forEach(function(cafe) {
                if (cafe.latitude && cafe.longitude) {
                    var marker = L.marker([cafe.latitude, cafe.longitude]).addTo(map);
                    
                    // POPUP ƒ∞√áERƒ∞ƒûƒ∞ (D√úZENLENDƒ∞)
                    var popupContent = `
                        <div style="text-align:center; color:#3e2723; font-family: 'Poppins', sans-serif;">
                            <h3 style="margin:0; font-size:1.2rem;">${cafe.name}</h3>
                            <p style="margin:5px 0; font-size:0.9rem;">üìç ${cafe.city}</p>
                            <p style="font-weight:bold; margin-bottom:10px;">‚≠êÔ∏è ${cafe.totalRating ? cafe.totalRating : 'Yeni'}</p>
                            <a href="/cafe/${cafe.cafeId}" style="background:#ffca28; color:#3e2723; padding:8px 20px; text-decoration:none; border-radius:10px; font-weight:bold; display:inline-block; font-size:0.9rem; border:1px solid #e6b800;">ƒ∞ncele</a>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                }
            });
        }
    </script>
</body>
</html>